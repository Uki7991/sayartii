<template>
    <div class="bg-gray-50 font-roboto">
        <header class="py-3 shadow-lg border-b border-gray-900 fixed top-0 z-10 w-full bg-gray-50">
            <div class="container mx-auto flex justify-between">
                <inertia-link href="/" class="h-11 w-auto">
                    <svg class="h-7 md:h-11 w-auto" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 694 391">
                        <defs></defs>
                        <g fill="none" fill-rule="evenodd">
                            <g fill-rule="nonzero">
                                <path fill="#333" d="M667 102.6a27 27 0 0119.1 33l-28 104.4a27 27 0 11-52.1-14l28-104.3a27 27 0 0133-19.1zm-72 0a27 27 0 0119.1 33l-28 104.4a27 27 0 11-52.1-14l28-104.3a27 27 0 0133-19.1zm-72 0a27 27 0 0119.1 33l-28 104.4a27 27 0 11-52.1-14l28-104.3a27 27 0 0133-19.1zm-80.2 36.3l.5.2A26.5 26.5 0 01462 172L442 241a27 27 0 01-33 18.7l-.4-.2a26.5 26.5 0 01-18.6-32.9l19.9-69a27 27 0 0133-18.7zm-216 0l.5.2A26.5 26.5 0 01246 172L226 241a27 27 0 01-33 18.7l-.4-.2a26.5 26.5 0 01-18.6-32.9l19.9-69a27 27 0 0133-18.7zM407.3 6l.2.1a26.7 26.7 0 0118.9 33L370 241a27 27 0 01-33 18.7h-.3a26.7 26.7 0 01-18.8-33l56.3-202a27 27 0 0133-18.8zM295.5 150l.4.1a26.6 26.6 0 0118.7 33l-49 173.2a27 27 0 01-33 18.8l-.3-.1a26.6 26.6 0 01-18.7-33l49-173.3a27 27 0 0133-18.7zm103.7 176a27 27 0 110-54 27 27 0 010 54zm-14.4 57.6a27 27 0 110-54 27 27 0 010 54zM255.2 63.2a27 27 0 110-54 27 27 0 010 54zm-18 61.2a27 27 0 110-54 27 27 0 010 54z"></path>
                                <path fill="#F4327F" d="M152.2 153a27 27 0 0119.1 33l-28 104.4a27 27 0 11-52.1-14l28-104.3a27 27 0 0133-19.1zm-72 0a27 27 0 0119.1 33l-28 104.4a27 27 0 11-52.1-14l28-104.3a27 27 0 0133-19.1zM104 376.4a27 27 0 110-54 27 27 0 010 54zm-72 0a27 27 0 110-54 27 27 0 010 54z"></path>
                            </g>
                            <path fill="#333" d="M469.5 367.5a6.9 6.9 0 01-7 7 6.9 6.9 0 01-7-7c0-2 .7-3.6 2-5 1.4-1.3 3-2 5-2s3.6.7 5 2c1.3 1.4 2 3 2 5zm57.3-6.7c0 4.7-1.6 8.2-4.7 10.5-3.1 2.2-6.2 3.3-9.3 3.3h-14.6c-3 0-6-1.1-9-3.3a11.5 11.5 0 01-3.2-4.4c-.7-1.8-1-3.8-1-6.1V336c0-4.7 1.4-8.2 4.3-10.5 1.4-1 3-1.8 4.4-2.4 1.6-.7 3-1 4.5-1h14.6a20.5 20.5 0 019.3 3c1.4 1 2.6 2.4 3.4 4.2a14 14 0 011.3 6.1v4.4c0 2.8-1.6 4.2-4.8 4.2-3.2 0-4.8-1.4-4.8-4.2v-3.7c0-1.5-.5-2.8-1.4-4-.9-1.2-2.4-1.8-4.5-1.8h-10.9c-2.1 0-3.7.6-4.6 1.8a6.4 6.4 0 00-1.3 4v24.6c0 1.4.4 2.7 1.3 3.9 1 1.2 2.5 1.8 4.6 1.8h10.9c2.1 0 3.6-.6 4.5-1.8a6.5 6.5 0 001.4-4v-4c0-2.6 1.6-4 4.8-4 3.2 0 4.8 1.4 4.8 4v4.2zm42.5-38.6c1.5 0 3 .3 4.6 1 1.6.6 3.2 1.4 4.7 2.4 1.4 1.1 2.6 2.6 3.4 4.3.8 1.8 1.2 3.8 1.2 6.2v24.7c0 4.7-1.6 8.2-4.7 10.5-3 2.2-6.1 3.3-9.2 3.3h-14a14.5 14.5 0 01-9.2-3.3c-3-2.2-4.6-5.7-4.6-10.5V336c0-2.4.4-4.4 1.2-6.2.8-1.7 2-3.2 3.4-4.3 1.4-1 3-1.8 4.6-2.4 1.6-.7 3.2-1 4.7-1h13.9zm-1.6 44.2c2.2 0 3.7-.6 4.6-1.8a6.5 6.5 0 001.3-4v-24.5c0-1.4-.4-2.7-1.3-4-1-1.1-2.4-1.7-4.6-1.7H557c-2.1 0-3.6.6-4.5 1.8a6.4 6.4 0 00-1.4 4v24.5c0 1.4.5 2.7 1.4 3.9.9 1.2 2.4 1.8 4.5 1.8h10.8zm57.3-29.6c0-.8-.2-1.5-.4-2.3-.2-.7-.5-1.4-.9-2-.7-1.4-2.3-2.1-4.7-2.1h-5.5c-2.4 0-4 .7-4.8 2a9 9 0 00-1 4.4v34.4c0 2.7-1.7 4.1-4.8 4.1-3.4 0-5-1.4-5-4V336c0-4.8 1.6-8.3 4.7-10.5 3.2-2.2 6.3-3.3 9.3-3.3h8.8a16.5 16.5 0 019.1 3.2 15.5 15.5 0 019.2-3.2h8.7c3 0 6.1 1.1 9.2 3.3 3.2 2.2 4.8 5.7 4.8 10.5v35.2c0 2.7-1.7 4.1-4.9 4.1-3.3 0-4.9-1.4-4.9-4v-34.5c0-.8 0-1.6-.2-2.3-.2-.8-.5-1.5-1-2.1a4 4 0 00-1.6-1.5c-.7-.3-1.8-.5-3-.5h-5.6c-2.4 0-4 .7-4.8 2a8.2 8.2 0 00-1 4.4v34.4c0 2.7-1.7 4.1-4.9 4.1s-4.8-1.4-4.8-4v-34.5z"></path>
                        </g>
                    </svg>
                </inertia-link>

                <div class="flex w-1/2">
                    <div @click="openFilters" class="bg-pink-500 flex space-x-1 px-3 items-center text-white rounded-l md:px-5 cursor-pointer">
                        <span class="text-base hidden md:block">Filters</span>
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" class="fill-current text-white"><path d="M13 5H22V7H13zM2 7L9 7 9 9 11 9 11 3 9 3 9 5 2 5zM9 17H22V19H9zM19 11H22V13H19zM17 15L17 9.012 15 9.012 15 11 2 11 2 13 15 13 15 15zM7 21L7 15 5 15 5 17 2 17 2 19 5 19 5 21z"></path></svg>
                    </div>
                    <div class="flex items-center border border-l-0 rounded-r px-3 border-gray-400 w-full bg-white">
                        <input type="text" placeholder="Search..." class="w-full border-0 focus:ring-0">
                        <button class="focus:outline-none">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" class="fill-current text-gray-600"><path d="M16.293 9.293L12 13.586 7.707 9.293 6.293 10.707 12 16.414 17.707 10.707z"></path></svg>
                        </button>
                    </div>
                </div>


                <div class="flex space-x-6">
                    <button @click="" class="flex items-center px-3 border border-gray-900 rounded bg-white">
                        <img class="h-6 w-7 object-cover object-left" src="https://sayartii.com/static/img/flags/ae.svg" alt="">
                    </button>

                    <button @click="openSidebar" class="flex items-center px-5 border border-gray-900 rounded bg-white">
                        Menu
                    </button>
                </div>
            </div>
        </header>


        <main>
            <slot></slot>
        </main>

        <div @click="openSellSidebar" class="animate-ping fixed bottom-8 right-8 md:bottom-16 md:right-16 rounded-full bg-pink-600 w-16 h-16 flex items-center justify-center text-white cursor-pointer">
        </div>
        <div @click="openSellSidebar" class="fixed bottom-8 right-8 md:bottom-16 md:right-16 rounded-full bg-pink-600 w-16 h-16 flex items-center justify-center text-white cursor-pointer">
            Sell
        </div>

        <sidebar @close="closeSidebar" :show="activeSidebar"></sidebar>
        <modular-sidebar classes="rounded-br-md w-2/6 min-h-full" title="You are searching" left @close="closeFilters" :show="filtersSidebar">
            <template #header>
                <div class="flex justify-between items-center p-8">
                    <p class="flex-grow text-center text-lg uppercase">You are searching</p>
                    <button class="focus:outline-none flex-initial" @click="closeFilters">
                        <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" class="fill-current text-black"><path d="M16.192 6.344L11.949 10.586 7.707 6.344 6.293 7.758 10.535 12 6.293 16.242 7.707 17.656 11.949 13.414 16.192 17.656 17.606 16.242 13.364 12 17.606 7.758z"></path></svg>
                    </button>
                </div>
            </template>
            <div class="px-8 overflow-y-auto">
                <menu-item-with-select>
                    <globe width="30" height="30" class="text-black"></globe>
                    <p class="ml-4">Location</p>
                </menu-item-with-select>
                <div class="py-2">
                    <label for="modelFilter">Make / Model</label>
                    <input type="text" id="modelFilter" class="w-full rounded-md focus:ring-black focus:border-black">
                </div>
                <div class="py-2">
                    <label for="yearFrom">Year</label>
                    <div class="flex space-x-2">
                        <input placeholder="From" type="number" id="yearFrom" class="flex-auto rounded-md focus:ring-black focus:border-black">
                        <input placeholder="To" type="number" class="flex-auto rounded-md focus:ring-black focus:border-black">
                    </div>
                </div>
                <div class="py-2">
                    <label for="keyword">Keyword</label>
                    <input type="text" id="keyword" class="w-full rounded-md focus:ring-black focus:border-black">
                </div>

                <div class="py-2">
                    <label for="priceFrom">Price</label>
                    <div class="flex space-x-2">
                        <input placeholder="Min" type="number" id="priceFrom" class="flex-auto rounded-md focus:ring-black focus:border-black">
                        <input placeholder="Max" type="number" class="flex-auto rounded-md focus:ring-black focus:border-black">
                    </div>
                </div>

                <div class="py-2">
                    <label for="mileageFrom">Mileage</label>
                    <div class="flex space-x-2">
                        <input placeholder="Min" type="number" id="mileageFrom" class="flex-auto rounded-md focus:ring-black focus:border-black">
                        <input placeholder="Max" type="number" class="flex-auto rounded-md focus:ring-black focus:border-black">
                    </div>
                </div>

                <div v-for="(item, index) in attributes" :key="index+'Filter'" class="py-1" :class="[index, attributes]">
                    <p class="mb-2">{{item.title}}</p>
                    <div class="flex flex-wrap">
                        <check-box v-if="item.type === 'checkbox'" class="flex-initial mr-2 mb-3" :class="indexAttr" v-for="(value, indexAttr) in item.attributesArr" :key="indexAttr+'checkboxFilter'" :name="index + 'Filter'" v-model="formFilters.attributesArr[index][indexAttr]" :type="value"></check-box>
                        <radio-box v-if="item.type === 'radio'" class="flex-initial mr-2 mb-3" v-for="(value, indexAttr) in item.attributesArr" :key="indexAttr+'radioFilter'" :name="index + 'Filter'" v-model="formFilters.attributesArr[index]" :type="value"></radio-box>
                    </div>
                </div>
            </div>
            <template v-slot:footer>
                <div class="flex mt-auto shadow-vertical-up">
                    <button class="w-1/2 flex items-center justify-center py-4 text-lg font-medium text-pink-600 bg-white">
                        Cancel
                    </button>
                    <button class="w-1/2 flex items-center justify-center py-4 text-white text-lg font-medium bg-pink-600">
                        7,641 results
                    </button>
                </div>
            </template>
        </modular-sidebar>
        <modular-sidebar title="Sell your car" classes="rounded-bl-md w-2/6 min-h-full" @close="closeSellSidebar" :show="sellSidebar">
            <div class="px-8 overflow-y-auto">
                <p class="capitalize text-center mb-4">Add images <span class="text-red-600">*</span></p>
                <file-pond
                    max-files="12"
                    :imagePreviewHeight="100"
                    allow-multiple="true"
                    name="test"
                    :server="server"
                ></file-pond>
                <p class="text-xs text-red-600 mb-2" v-if="$page.props.errors.images">{{$page.props.errors.images}}</p>
                <p class="capitalize text-center my-4">Car information</p>
                <div class="py-1">
                    <label for="model">Make / Model <span class="text-red-600">*</span></label>
                    <input type="text" v-model="formCreate.model" id="model" class="w-full rounded-md focus:ring-black focus:border-black">
                    <p class="text-xs text-red-600 mb-2" v-if="$page.props.errors.model">{{$page.props.errors.model}}</p>
                </div>
                <div class="py-1">
                    <label for="year">Year <span class="text-red-600">*</span></label>
                    <input type="number" id="year" v-model="formCreate.year" class="w-full rounded-md focus:ring-black focus:border-black">
                    <p class="text-xs text-red-600 mb-2" v-if="$page.props.errors.year">{{$page.props.errors.year}}</p>
                </div>
                <div class="py-1">
                    <label for="location">Location <span class="text-red-600">*</span></label>
                    <select id="location" v-model="formCreate.location" class="w-full rounded-md focus:ring-black focus:border-black">
                        <option>Egypt</option>
                        <option>Algeria</option>
                        <option>Arabian</option>
                    </select>
                    <p class="text-xs text-red-600 mb-2" v-if="$page.props.errors.location">{{$page.props.errors.location}}</p>
                </div>
                <div class="py-1">
                    <label for="price">Price <span class="text-red-600">*</span></label>
                    <input type="number" v-model="formCreate.price" id="price" class="w-full rounded-md focus:ring-black focus:border-black">
                    <p class="text-xs text-red-600 mb-2" v-if="$page.props.errors.price">{{$page.props.errors.price}}</p>
                </div>
                <div class="py-1">
                    <label for="mileage">Mileage <span class="text-red-600">*</span></label>
                    <input type="number" v-model="formCreate.mileage" id="mileage" class="w-full rounded-md focus:ring-black focus:border-black">
                    <p class="text-xs text-red-600 mb-2" v-if="$page.props.errors.mileage">{{$page.props.errors.mileage}}</p>
                </div>
                <div class="py-1">
                    <label for="phone">Phone <span class="text-red-600">*</span></label>
                    <input type="number" v-model="formCreate.phone" id="phone" class="w-full rounded-md focus:ring-black focus:border-black">
                    <p class="text-xs text-red-600 mb-2" v-if="$page.props.errors.phone">{{$page.props.errors.phone}}</p>
                </div>
                <div class="py-1">
                    <label for="whatsapp">Whatsapp <span class="text-red-600">*</span></label>
                    <input type="number" v-model="formCreate.whatsapp" id="whatsapp" class="w-full rounded-md focus:ring-black focus:border-black">
                    <p class="text-xs text-red-600 mb-2" v-if="$page.props.errors.whatsapp">{{$page.props.errors.whatsapp}}</p>
                </div>
                <div class="py-1">
                    <label for="title">Title <span class="text-red-600">*</span></label>
                    <input type="number" id="title" v-model="formCreate.title" class="w-full rounded-md focus:ring-black focus:border-black">
                    <p class="text-xs text-red-600 mb-2" v-if="$page.props.errors.title">{{$page.props.errors.title}}</p>
                </div>
                <div class="py-1">
                    <label for="description">Description <span class="text-red-600">*</span></label>
                    <textarea id="description" rows="4" v-model="formCreate.description" class="w-full rounded-md focus:ring-black focus:border-black"></textarea>
                    <p class="text-xs text-red-600 mb-2" v-if="$page.props.errors.description">{{$page.props.errors.description}}</p>
                </div>
                <div v-for="(item, index) in attributes" :key="index+'Create'" class="py-1" :class="[index, attributes]">
                    <p class="mb-2">{{item.title}} <span v-if="item.type === 'radio'" class="text-red-600">*</span></p>
                    <div class="flex flex-wrap">
                        <check-box v-if="item.type === 'checkbox'" class="flex-initial mr-2 mb-3" :class="indexAttr" v-for="(value, indexAttr) in item.attributesArr" :key="indexAttr+'checkbox'" :name="index" v-model="formCreate.attributesArr[index][indexAttr]" :type="value"></check-box>
                        <radio-box v-if="item.type === 'radio'" class="flex-initial mr-2 mb-3" v-for="(value, indexAttr) in item.attributesArr" :key="indexAttr+'radio'" :name="index" v-model="formCreate.attributesArr[index]" :type="value"></radio-box>
                        <p class="text-xs text-red-600 mb-2 w-full" v-if="$page.props.errors['attributesArr.'+index]">{{$page.props.errors['attributesArr.'+index]}}</p>
                    </div>
                </div>
            </div>
            <template #footer>
                <div @click="submitFormCreate" class="bg-pink-600 py-4 flex items-center justify-center text-white text-lg font-medium mt-auto cursor-pointer">
                    Create
                </div>
            </template>
        </modular-sidebar>

    </div>
</template>

<script>

    import Sidebar from "@/Components/Sidebar";
    import ModularSidebar from "@/Components/ModularSidebar";
    import MenuItemWithSelect from "@/Components/MenuItemWithSelect";
    import _ from "lodash";

    // Import Vue FilePond
    import vueFilePond from 'vue-filepond';

    // Import FilePond styles
    import 'filepond/dist/filepond.min.css';

    // Import image preview plugin styles
    import 'filepond-plugin-image-preview/dist/filepond-plugin-image-preview.min.css';

    // Import image preview and file type validation plugins
    import FilePondPluginFileValidateType from 'filepond-plugin-file-validate-type';
    import FilePondPluginImagePreview from 'filepond-plugin-image-preview';
    import CheckBox from "@/Components/CheckBox";
    import RadioBox from "@/Components/RadioBox";
    import Globe from "@/Components/Icons/Globe";
    const FilePond = vueFilePond(FilePondPluginFileValidateType, FilePondPluginImagePreview);

    export default {
        components: {
            Globe,
            RadioBox,
            CheckBox,
            MenuItemWithSelect,
            ModularSidebar,
            Sidebar,
            FilePond,
        },

        data() {
            return {
                server: {
                    process:(fieldName, file, metadata, load, error, progress, abort, transfer, options) => {
                        let self = this;
                        // fieldName is the name of the input field
                        // file is the actual file object to send
                        const formData = new FormData();
                        formData.append(fieldName, file, file.name);

                        const request = new XMLHttpRequest();
                        request.open('POST', route('images.post-image', {dir: 'announcements', prefix: 'announcements'}));

                        // Should call the progress method to update the progress to 100% before calling load
                        // Setting computable to false switches the loading indicator to infinite mode
                        request.upload.onprogress = (e) => {
                            progress(e.lengthComputable, e.loaded, e.total);
                        };

                        // Should call the load method when done and pass the returned server file id
                        // this server file id is then used later on when reverting or restoring a file
                        // so your server knows which file to return without exposing that info to the client
                        request.onload = function() {
                            if (request.status >= 200 && request.status < 300) {
                                // the load method accepts either a string (id) or an object
                                self.formCreate.images.push(JSON.parse(request.responseText));

                                load(request.responseText);
                            }
                            else {
                                // Can call the error method if something is wrong, should exit after
                                error('oh no');
                            }
                        };

                        request.send(formData);

                        // Should expose an abort method so the request can be cancelled
                        return {
                            abort: () => {
                                // This function is entered if the user has tapped the cancel button
                                request.abort();

                                // Let FilePond know the request has been cancelled
                                abort();
                            }
                        };
                    },
                    revert: (uniqueFileId, load, error) => {
                        let self = this;
                        // Should remove the earlier created temp file here
                        // ...

                        window.axios.delete(self.route('images.delete-image', {filename: JSON.parse(uniqueFileId)})).then(() => {
                            let index = self.formCreate.images.indexOf(JSON.parse(uniqueFileId));
                            if (index !== -1) {
                                self.formCreate.images.splice(index, 1);
                            }
                            load();
                        }).catch(() => {
                            error('oh no');
                        })

                    }
                },
                activeSidebar: false,
                filtersSidebar: false,
                sellSidebar: false,
                attributes: [],
                formCreate: this.$inertia.form({
                    title: null,
                    description: null,
                    price: null,
                    phone: null,
                    mileage: null,
                    whatsapp: null,
                    year: null,
                    model: null,
                    location: null,
                    images: [],
                    attributesArr: {},
                }),
                formFilters: this.$inertia.form({
                    attributesArr: {},
                }),
            }
        },

        methods: {
            logout() {
                this.$inertia.post(route('logout'));
            },
            openSidebar() {
                this.hideBody();
                this.activeSidebar = true;
            },
            closeSidebar() {
                this.showBody();
                this.activeSidebar = false;
            },
            openFilters() {
                this.hideBody();
                this.filtersSidebar = true;
            },
            closeFilters() {
                this.showBody();
                this.filtersSidebar = false;
            },
            openSellSidebar() {
                this.hideBody();
                this.sellSidebar = true;
            },
            closeSellSidebar() {
                this.showBody();
                this.sellSidebar = false;
            },
            submitFormCreate() {
                this.$inertia.post('/announcements', this.formCreate);
            },
        },
        mounted() {
            window.axios.get('/api/attributes')
                .then(data => {
                    this.attributes = data.data;
                    _.forEach(data.data, (value, index) => {
                        if (value.type === 'radio') {
                            this.$set(this.formCreate.attributesArr, index, '');
                            this.$set(this.formFilters.attributesArr, index, '');
                        }
                        if (value.type === 'checkbox') {
                            this.$set(this.formCreate.attributesArr, index, {});
                            this.$set(this.formFilters.attributesArr, index, {});
                            _.forEach(value.attributesArr, (item, key) => {
                                this.$set(this.formCreate.attributesArr[index], key, item.status);
                                this.$set(this.formFilters.attributesArr[index], key, item.status);
                            })
                        }
                    })
                })
                .catch(error => {
                    console.log(error);
                })
        }
    }
</script>
